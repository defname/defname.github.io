import{a as c,V as l,b as d,M as m,T as h,O as p,c as g,d as u,F as y,P as f,S as w,I as M,e as k,f as v,g as S,t as _,h as R}from"../../async-vendor-gRlujhSQ.js";import{i as b}from"../assets/map_marker_small-7oYklHFz.js";import{T as x,ak as E}from"../../vendor-fe-4Mo55.js";const C=[13.51930551404059,52.453945317554826],N={components:{IonIcon:x},emits:["addressSelected"],name:"Map",props:{initialCenter:Array,results:{type:Array,default:[]}},data(){return c(),{mainMap:void 0,markers:new l,view:new d({center:C,zoom:10,maxZoom:21}),locateIcon:E}},watch:{results(t){if(this.mainMap===void 0)throw Error("MainMap not initialized");if(console.log(t),this.markers.clear(),t.forEach(e=>{this.addMarker(e)}),t.length!=0){var s=void 0;t.forEach(e=>{console.log(e);const a=e.bbox;s===void 0?s=a:a!==void 0&&R(s,a)}),this.view.fit(s),this.view.setZoom(this.view.getZoom()*.9)}}},mounted(){c(),this.mainMap=new m({layers:[new h({source:new p})],target:"map-element"}),this.mainMap.setView(this.view);const t=new g;t.setSource(this.markers),this.mainMap.addLayer(t),this.mainMap.on("click",this.onMapClick);const s=document.createElement("div");s.className="ol-control ol-unselectable locate-control",s.innerHTML='<button title="Locate me">üìç</button>';const e=this;s.addEventListener("click",function(){e.geolocate()}),this.mainMap.addControl(new u({element:s}))},methods:{async geolocate(){console.log("TODO")},addMarker(t,s){const e=s||t.geometry.coordinates,a=this.displayName(t),n=this.createMarker(e,a,t);this.markers.addFeature(n)},createMarker(t,s,e=void 0){const a=new y(new f(t));a.set("meta",e);const n=new w({image:new M({anchor:[.5,0],anchorXUnits:"fraction",anchorYUnits:"pixels",anchorOrigin:"bottom-left",size:[60,97],scale:.45,opacity:1,src:b}),text:new k({offsetY:10,text:s,scale:1.5,fill:new v({color:"#fff"}),stroke:new S({color:"0",width:2})})});return a.setStyle(n),a},displayName(t,s=!1){const e=t.properties;if(!e)return"";if(!e.address){if(e.name&&!s)return e.name;if(e.display_name)return e.display_name}let a="";if(e.addresstype&&e.address[e.addresstype]&&(a=e.address[e.addresstype]),a&&!s)return a;let n="";e.address.road&&(n=e.address.road),e.address.house_number&&(n+=" "+e.address.house_number);let o="";e.address.postcode&&(o=e.address.postcode),e.address.city?o+=" "+e.address.city:e.address.town?o+=" "+e.address.town:e.address.village&&(o+=" "+e.address.village);let r=n+", "+o;return a?a+", "+r:r},nominatimReverseRequest(t){const s=t[0],e=t[1],a={lon:s,lat:e,format:"geojson",limit:1},o="https://nominatim.openstreetmap.org/reverse?"+Object.keys(a).map(function(r){return encodeURIComponent(r)+"="+encodeURIComponent(a[r])}).join("&");return console.log("URL Request NOMINATIM-Reverse: "+o),fetch(o).then(r=>r.json()).then(r=>r.features[0])},async onMapClick(t){var n;let s=!1;if((n=this.mainMap)==null||n.forEachFeatureAtPixel(t.pixel,o=>{if(console.log(o),o===this.markers.getFeatures()[0]){console.log(o.get("meta")),s=!0;const r=o.get("meta").geometry.coordinates.map(i=>parseFloat(i));this.nominatimReverseRequest(r).then(i=>{console.log(i),o.set("meta",i),this.$emit("addressSelected",i)})}}),s)return;console.log("evt.coordinate: "+t.coordinate);const e=_(t.coordinate,"EPSG:3857","EPSG:4326");console.log("Mouse Click coordinates: "+e);const a=t.coordinate;this.nominatimReverseRequest(a).then(o=>{if(console.log(o),this.displayName(o),this.$emit("addressSelected",o),this.markers.clear(),!o.geometry||o.geometry.type!=="Point"){console.warn("Feature is not a Point"),console.warn(o);return}this.addMarker(o,a)}).catch(o=>{console.log(o)})}},ionViewWillEnter(){},ionViewDidEnter(){var t;(t=this.mainMap)==null||t.updateSize(),this.markers.changed()}};export{N as _};
