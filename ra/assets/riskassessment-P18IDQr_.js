var w=Object.defineProperty;var b=(o,e,s)=>e in o?w(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s;var a=(o,e,s)=>(b(o,typeof e!="symbol"?e+"":e,s),s);import{m as k,b as f,c as D,e as E,d as g,S as h}from"./helpers-6pYLpwcd.js";import{l as c}from"./livequery-Ch80CViN.js";import{a1 as R,x as v,u as M,a2 as q,aj as x,ao as B}from"./index-sS98weYx.js";import{l as y}from"./liveriskstree-BHmaqo59.js";const p={company:"",startDate:0,endDate:void 0,address:"",jobDescr:"",equipment:[],technicians:[],supervisors:[],access:[],risks:[],measures:{},meta:{}};class S{constructor(e){a(this,"id");a(this,"descr");a(this,"company");a(this,"startDate");a(this,"endDate");a(this,"address");a(this,"jobDescr");a(this,"equipment");a(this,"technicians");a(this,"supervisors");a(this,"access");a(this,"risks");a(this,"allRisks");a(this,"measures");a(this,"meta");a(this,"initData");a(this,"isReady");a(this,"ready");this.initData={...p},this.isReady=!1,this.init(e)}init(e){this.isReady=!1,this.measures={},this.meta={},this.allRisks=[],k(this,f(p)),e&&k(this,e),this.updateInitData()}clear(){this.init(),this.id=void 0}updateInitData(){const e=f(D(this,p));this.initData=e}reset(){k(this,this.initData)}modified(){for(let e in this.initData)if(!E(this[e],this.initData[e]))return!0;return!1}loadFromDb(e){return this.init({id:e}),this.ready=c.ready().then(()=>c.table("riskassessments").getAsPromise(e)).then(s=>{this.init(s),this.isReady=!0}).catch(s=>{throw Error(s)}),this.ready}async save(){if(this.id===void 0)throw Error("Attempt to update without id");let e={};return e=f(D(this,p)),g.riskassessments.update(this.id,e).then(s=>{if(s===0)throw Error("Could not update. Does ID "+this.id+" exist?");const n=Math.floor(Date.now()/1e3);g.riskassessmentsmeta.update(this.id,{lastChange:n}),this.updateInitData()})}dateStr(e){return e.getUTCFullYear()+"-"+(e.getUTCMonth()+1)+"-"+e.getUTCDate()}getStartDate(){return new Date(this.startDate)}setStartDate(e){this.startDate=this.dateStr(e)}getEndDate(){if(this.endDate)return new Date(this.endDate)}setEndDate(e){e===void 0?this.endDate=void 0:this.endDate=this.dateStr(e)}async calcAllRisks(){await y.ready();const e=await c.table("measures").ready(),s=await c.table("equipment").ready(),n=[],i=[...this.risks];for(this.resetMetaAddedBy(),this.equipment.forEach(t=>{s.get(t).causeRisks.forEach(r=>{i.push(r);const d=this.getMeta(r);d.addedBy.find(u=>u.id===t&&u.type==="equipment")||d.addedBy.push({id:t,type:"equipment"})})});i.length>0;){const t=i.pop();n.includes(t)||(n.push(t),this.getMeasures(t).forEach(r=>{e.get(r).causeRisks.forEach(d=>{i.push(d);const u=this.getMeta(d);u.addedBy.find(m=>m.id===r&&m.type==="measure")||u.addedBy.push({id:r,type:"measure"})})}))}return this.allRisks=n,n}resetMetaAddedBy(){for(let e in this.meta)this.getMeta(parseInt(e)).addedBy.length=0}getMeta(e){return this.meta[e]===void 0&&(this.meta[e]={risk:e,addedBy:[]}),this.meta[e]}getMeasures(e){return this.measures[e]===void 0&&(this.measures[e]=[]),this.measures[e]}getMeasuresAsRef(e){return v(this.getMeasures(e))}addSector(e={}){const s=this.access.map(n=>n.id?n.id:0).reduce((n,i)=>n>i?n+1:i+1,0);this.access.push({id:s,title:"Neuer Sektor "+s,entrance:"",exit:"",anchorPoints:"",comment:"",rescue:"",...e})}}const l=R(new S);function A(o){const e=M();let s=o;return e&&e.path.startsWith("/riskassessment")&&e.params.id!==void 0&&(s=parseInt(e.params.id)),s===void 0||l.id===s||l.loadFromDb(s),l}function L(o){const e=A(o),s=v([]),n=()=>{console.log("useLiveAllRisks(): updateAllRisks()"),e.calcAllRisks().then(i=>{s.value=i,console.log("useLiveAllRisks(): updateAllRisks() -> Done")})};return q([()=>e.risks,()=>e.isReady],n),x(()=>{n()}),s}function U(o){const e=A(o);c.table("equipment");const s=R({risks:[]});async function n(){s.sector={},await e.ready,await y.ready();const i=await c.table("measures");await e.calcAllRisks(),s.risks=e.allRisks.map(t=>({risk:y.get(t),measures:e.measures[t].map(r=>i.get(r)),meta:e.getMeta(t)})),s.sector.access=s.risks.filter(t=>t.risk.sector===h.Access),s.sector.environment=s.risks.filter(t=>t.risk.sector===h.Environment),s.sector.work=s.risks.filter(t=>t.risk.sector===h.Work),s.categories=s.risks.reduce((t,r)=>{console.log(t),console.log(r);const d=r.risk.factor.category,u=t.findIndex(m=>m.id===d.id);return u===-1?(t.push({...d,risks:[r]}),t):(t[u].risks.push(r),t)},[]),s.sector.access=s.risks.filter(t=>t.risk.sector===h.Access),s.sector.environment=s.risks.filter(t=>t.risk.sector===h.Environment),s.sector.work=s.risks.filter(t=>t.risk.sector===h.Work)}return n(),e.ready.then(()=>{c.table("technicians").ready().then(i=>{s.technicians=e.technicians.map(t=>i.get(t)),s.supervisors=e.supervisors.map(t=>i.get(t))}),c.table("equipment").ready().then(i=>{s.equipment=e.equipment.map(t=>i.get(t))}),s.access=e.access.map(i=>{const t={};t.id=i.id,t.title=i.title;for(let r in i)r==="id"||r==="title"||(t[r]=B.parse(i[r]));return t}),s.company=e.company,s.address=e.address,s.startDate=e.startDate,s.endDate=e.endDate,s.jobDescr=e.jobDescr}),s}export{L as a,U as b,p as d,A as u};
