!function(){function e(e,t,s){var i;return(t="symbol"==typeof(i=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var i=s.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(t,"string"))?i:String(i))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}System.register(["./database-legacy-8-jSFMl0.js","./livequery-legacy-E6C-7scz.js","./index-legacy-La_jvRt6.js","./liveriskstree-legacy-Mt7epSA0.js","./helpers-legacy-wNo1H66i.js"],(function(t,s){"use strict";var i,a,r,n,d,o,h,c,u,m,l,p,g,v,f,y;return{setters:[e=>{i=e.m,a=e.a,r=e.p,n=e.b,d=e.c,o=e.d,h=e.i},e=>{c=e.l},e=>{u=e.ak,m=e.x,l=e.u,p=e.al,g=e.aB,v=e.ab},e=>{f=e.l},e=>{y=e.a}],execute:function(){t({a:function(){return{addNewRiskAssessment:function(e="default",t=s){return o.riskassessments.add({...t}).then((t=>{const s=Math.floor(Date.now()/1e3);o.riskassessmentsmeta.add({id:t,descr:"Neue Gefährdungsbeurteilung "+t,created:s,lastChange:s,type:e}).then((()=>{}))}))},duplicateRiskAssessment:async function(e){return o.riskassessments.get(e).then((t=>{if(void 0===t)throw Error("riskassessment "+e+" canno be duplicated, since it does not exist in the database");return delete t.id,o.riskassessments.add(t)})).then((t=>o.riskassessmentsmeta.get(e).then((s=>{if(void 0===s)throw Error("riskassessmentMeta for riskassessment "+e+" not found in database.");const i=Math.floor(Date.now()/1e3);return o.riskassessmentsmeta.add({...s,id:t,descr:"Kopie von "+s.descr,created:i,lastChange:i})}))))},changeRiskAssessmentMetaDescr:function(e,t){if(void 0!==k.id)return o.riskassessmentsmeta.update(e,{descr:t})},changeRiskAssessmentType:async function(e,t){return o.riskassessmentsmeta.update(e,{type:t})},deleteRiskAssessment:function(e){y("Soll der Einsatzplan wirklich unwideruflich gelöscht werden?",{text:"Löschen",icon:v,handler:()=>{o.table("riskassessments").delete(e),o.table("riskassessmentsmeta").delete(e)}})}}},b:function(e){const t=D(e),s=m([]),i=()=>{console.log("useLiveAllRisks(): updateAllRisks()"),t.calcAllRisks().then((e=>{s.value=e,console.log("useLiveAllRisks(): updateAllRisks() -> Done")}))};return p([()=>t.risks,()=>t.isReady],i),g((()=>{i()})),s},c:function(e){const t=D(e),s=u({risks:[]});async function i(){var e;await t.ready,await f.ready();const i=await c.table("measures").ready();await t.calcAllRisks(),s.risks=t.allRisks.map((e=>({risk:f.get(e),measures:t.measures[e].map((e=>i.get(e))),meta:t.getMeta(e)}))),s.categories=s.risks.reduce(((e,t)=>{const s=t.risk.factor.category,i=e.findIndex((e=>e.id===s.id));return-1===i?(e.push({...s,risks:[t]}),e):(e[i].risks.push(t),e)}),[]);const a=await c.table("technicians").ready();s.technicians=t.technicians.map((e=>a.get(e))),s.supervisors=t.supervisors.map((e=>a.get(e)));const r=await c.table("equipment").ready();s.equipment=t.equipment.map((e=>r.get(e))),s.access=t.access.map((e=>e)),s.company=t.company,s.address=t.address,s.startDate=t.startDate,s.endDate=t.endDate,s.jobDescr=t.jobDescr,s.signatures=null===(e=t.signatures)||void 0===e?void 0:e.filter((e=>-1===t.lastChange||e.time>t.lastChange)),s.signature=-1===t.lastChange||t.signature&&t.lastChange<t.signature.time?t.signature:void 0}return s.ready=i(),{exportData:s,updateExportData:i}},u:D});const s={company:"",startDate:0,endDate:void 0,address:"",jobDescr:"",equipment:[],technicians:[],supervisors:[],access:[],risks:[],measures:{},meta:{}};t("S",class{constructor(t){e(this,"time",void 0),e(this,"signature",void 0),this.signature=t,this.time=Date.now()/1e3}});const k=u(new class{constructor(t){e(this,"id",void 0),e(this,"descr",void 0),e(this,"company",void 0),e(this,"startDate",void 0),e(this,"endDate",void 0),e(this,"address",void 0),e(this,"jobDescr",void 0),e(this,"equipment",void 0),e(this,"technicians",void 0),e(this,"supervisors",void 0),e(this,"access",void 0),e(this,"risks",void 0),e(this,"allRisks",void 0),e(this,"measures",void 0),e(this,"meta",void 0),e(this,"initData",void 0),e(this,"isReady",void 0),e(this,"ready",void 0),e(this,"lastChange",void 0),e(this,"signatures",void 0),e(this,"signature",void 0),this.initData={...s},this.isReady=!1,this.init(t)}init(e){this.isReady=!1,this.measures={},this.meta={},this.allRisks=[],this.lastChange=-1,this.signatures=[],this.signature=void 0,i(this,a(s)),e&&i(this,e),this.updateInitData()}clear(){this.init(),this.id=void 0}updateInitData(){const e=a(r(this,s));this.initData=e}reset(){i(this,this.initData)}modified(){for(let e in this.initData)if(!n(this[e],this.initData[e]))return!0;return!1}changes(){return d(this.initData,this,Object.keys(this.initData))}loadFromDb(e){return this.init({id:e}),this.ready=c.ready().then((()=>c.table("riskassessments").getAsPromise(e))).then((e=>{this.init(e),this.isReady=!0})).catch((e=>{throw Error(e)})),this.ready}async save(){if(void 0===this.id)throw Error("Attempt to update without id");let e={};return e=a(r(this,s)),o.riskassessments.update(this.id,e).then((e=>{if(0===e)throw Error("Could not update. Does ID "+this.id+" exist?");const t=Math.floor(Date.now()/1e3);o.riskassessmentsmeta.update(this.id,{lastChange:t}),this.lastChange=t,this.updateInitData()}))}dateStr(e){return e.getUTCFullYear()+"-"+(e.getUTCMonth()+1)+"-"+e.getUTCDate()}getStartDate(){return new Date(this.startDate)}setStartDate(e){this.startDate=this.dateStr(e)}getEndDate(){return this.endDate?new Date(this.endDate):void 0}setEndDate(e){this.endDate=void 0===e?void 0:this.dateStr(e)}async calcAllRisks(){await f.ready();const e=await c.table("measures").ready(),t=await c.table("equipment").ready(),s=[],i=[...this.risks];for(this.resetMetaAddedBy(),this.equipment.forEach((e=>{t.get(e).causeRisks.forEach((t=>{i.push(t);const s=this.getMeta(t);s.addedBy.find((t=>t.id===e&&"equipment"===t.type))||s.addedBy.push({id:e,type:"equipment"})}))}));i.length>0;){const t=i.pop();s.includes(t)||(s.push(t),this.getMeasures(t).forEach((t=>{e.get(t).causeRisks.forEach((e=>{i.push(e);const s=this.getMeta(e);s.addedBy.find((e=>e.id===t&&"measure"===e.type))||s.addedBy.push({id:t,type:"measure"})}))})))}return this.allRisks=s,s}resetMetaAddedBy(){for(let e in this.meta)this.getMeta(parseInt(e)).addedBy.length=0}getMeta(e){return void 0===this.meta[e]&&(this.meta[e]={risk:e,addedBy:[]}),this.meta[e]}getMeasures(e){return void 0===this.measures[e]&&(this.measures[e]=[]),this.measures[e]}getMeasuresAsRef(e){return m(this.getMeasures(e))}addSector(e={}){const t=this.access.map((e=>e.id?e.id:0)).reduce(((e,t)=>e>t?e+1:t+1),0),s={id:t,title:"Neuer Sektor "+t,entrance:"",exit:"",anchorPoints:"",comment:"",rescue:"",...e};this.access.push(s)}updateTechnicianSignature(e,t){void 0===this.signatures&&(this.signatures=[]),this.signatures[e]=t}mergePreset(e,t=!1){console.log("RiskAssessment: mergePreset()"),console.log(e);function s(e,t,s=((e,t)=>e===t)){const i=t.filter((t=>-1===e.findIndex((e=>s(t,e)))));return[...e,...i]}if(["company","startDate","endDate","address","jobDescr"].forEach((s=>{h(e[s])||(t||h(this[s]))&&(this[s]=e[s])})),e.equipment&&e.equipment.length>0&&(this.equipment=s(this.equipment,e.equipment)),e.risks&&e.risks.length>0&&(this.risks=s(this.risks,e.risks)),e.measures)for(let a in e.measures)void 0===this.measures[a]?this.measures[a]=[...e.measures[a]]:this.measures[a]=s(this.measures[a],e.measures[a]);function i(e,t,s="\n"){return void 0===e||""===e.trim()?t:""===t.trim()?e:e+s+t}if(e.access&&e.access.forEach((e=>{const t=this.access.find((t=>e.title===t.title));t?["anchorPoints","comment","entrance","exit","rescue"].forEach((s=>{t[s]=i(t[s],e[s])})):(delete e.id,this.addSector(e))})),e.meta)for(let a in e.meta)this.meta[a]||(this.meta[a]={risk:parseInt(a),addedBy:[],comment:""}),this.meta[a].comment=i(this.meta[a].comment,e.meta[a].comment||"");this.calcAllRisks()}});function D(e){const t=l();let s=e;return t&&t.path.startsWith("/riskassessment")&&void 0!==t.params.id&&(s=parseInt(t.params.id)),void 0===s||k.id===s||k.loadFromDb(s),k}}}}))}();
